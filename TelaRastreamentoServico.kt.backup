            color = Color(0xFF2D2D2D),
            maxLines = maxLines,
            overflow = TextOverflow.Ellipsis,
            modifier = Modifier.weight(1f)
        )
    }
}
package com.exemple.facilita.screens
@Composable
fun InfoSection(
    title: String,
    icon: ImageVector,
    items: List<InfoItem>
) {
    Column(
        modifier = Modifier.fillMaxWidth()
    ) {
        Row(
            verticalAlignment = Alignment.CenterVertically,
            modifier = Modifier.padding(bottom = 12.dp)
        ) {
            Box(
                modifier = Modifier
                    .size(32.dp)
                    .background(Color(0xFF019D31).copy(alpha = 0.1f), CircleShape),
                contentAlignment = Alignment.Center
            ) {
                Icon(
                    icon,
                    contentDescription = null,
                    tint = Color(0xFF019D31),
                    modifier = Modifier.size(18.dp)
                )
            }
            Spacer(modifier = Modifier.width(10.dp))
            Text(
                text = title,
                fontSize = 16.sp,
                fontWeight = FontWeight.Bold,
                color = Color(0xFF2D2D2D)
            )
        }

        Column(
            modifier = Modifier
                .fillMaxWidth()
                .clip(RoundedCornerShape(12.dp))
                .background(Color(0xFFF5F5F5))
                .padding(12.dp),
            verticalArrangement = Arrangement.spacedBy(10.dp)
        ) {
            items.forEach { item ->
                InfoItemRow(item)
            }
        }
    }
}

@Composable
fun InfoItemRow(item: InfoItem) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.Top
    ) {
        Text(
            text = item.label,
            fontSize = 13.sp,
            fontWeight = FontWeight.Medium,
            color = Color(0xFF6D6D6D),
            modifier = Modifier.weight(0.4f)
        )
        Text(
            text = item.value,
            fontSize = 13.sp,
            fontWeight = FontWeight.SemiBold,
            color = Color(0xFF2D2D2D),
            textAlign = TextAlign.End,
            maxLines = 3,
            overflow = TextOverflow.Ellipsis,
            modifier = Modifier.weight(0.6f)
        )
    }
}

data class InfoItem(
    val label: String,
    val value: String
)

import android.util.Log
import android.widget.Toast
import androidx.compose.animation.core.*
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.KeyboardArrowLeft
import androidx.compose.material.icons.automirrored.filled.Message
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.lifecycle.viewmodel.compose.viewModel
import androidx.navigation.NavController
import com.exemple.facilita.network.WebSocketManager
import com.exemple.facilita.utils.TokenManager
import com.exemple.facilita.viewmodel.ServicoViewModel
import com.google.android.gms.maps.CameraUpdateFactory
import com.google.android.gms.maps.model.BitmapDescriptorFactory
import com.google.android.gms.maps.model.CameraPosition
import com.google.android.gms.maps.model.LatLng
import com.google.maps.android.compose.*
import kotlinx.coroutines.delay

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun TelaRastreamentoServico(
    navController: NavController,
    servicoId: String
) {
    val context = LocalContext.current
    val viewModel: ServicoViewModel = viewModel()

    val servico by viewModel.servico.collectAsState()
    val isLoading by viewModel.isLoading.collectAsState()

    val token = TokenManager.obterToken(context) ?: ""
    val userId = TokenManager.obterUserId(context) ?: 0

    var mostrarDialogoCancelar by remember { mutableStateOf(false) }
    var mostrarDetalhes by remember { mutableStateOf(false) }

    // WebSocket Manager
    val webSocketManager = remember { WebSocketManager.getInstance() }
    val isSocketConnected by webSocketManager.isConnected.collectAsState()
    val locationUpdate by webSocketManager.locationUpdate.collectAsState()

    // Posições no mapa - com atualização do WebSocket
    var prestadorLat by remember { mutableStateOf(servico?.prestador?.latitudeAtual ?: -23.550520) }
    var prestadorLng by remember { mutableStateOf(servico?.prestador?.longitudeAtual ?: -46.633308) }

    // Atualiza posição quando recebe do WebSocket
    LaunchedEffect(locationUpdate) {
        locationUpdate?.let { update ->
            if (update.servicoId.toString() == servicoId) {
                prestadorLat = update.latitude
                prestadorLng = update.longitude
                Log.d("TelaRastreamento", "Posição atualizada via WebSocket: ${update.latitude}, ${update.longitude}")
            }
        }
    }

    val prestadorPos = LatLng(prestadorLat, prestadorLng)

    val destinoLat = servico?.localizacao?.latitude ?: -23.561414
    val destinoLng = servico?.localizacao?.longitude ?: -46.656139
    val destinoPos = LatLng(destinoLat, destinoLng)

    val cameraPositionState = rememberCameraPositionState {
        position = CameraPosition.fromLatLngZoom(prestadorPos, 15f)
    }

    // Conecta ao WebSocket
    LaunchedEffect(servicoId, userId) {
        if (userId > 0) {
            webSocketManager.connect(
                userId = userId,
                userType = "contratante",
                userName = TokenManager.obterNomeUsuario(context) ?: "Usuário"
            )
            delay(1000) // Aguarda conexão
            webSocketManager.joinServico(servicoId)
        }
    }

    // Inicia o monitoramento via API
    LaunchedEffect(servicoId) {
        if (token.isNotEmpty()) {
            viewModel.iniciarMonitoramento(token, servicoId)
        }
    }

    // Monitora mudanças de status
    LaunchedEffect(servico?.status) {
        when (servico?.status) {
            "CONCLUIDO" -> {
                Toast.makeText(context, "Serviço concluído com sucesso!", Toast.LENGTH_LONG).show()
                webSocketManager.disconnect()
                delay(2000)
                navController.navigate("tela_home") {
                    popUpTo("tela_home") { inclusive = true }
                }
            }
            "CANCELADO" -> {
                Toast.makeText(context, "Serviço cancelado", Toast.LENGTH_SHORT).show()
                webSocketManager.disconnect()
                navController.navigate("tela_home") {
                    popUpTo("tela_home") { inclusive = true }
                }
            }
        }
    }

    // Atualiza câmera quando prestador se move
    LaunchedEffect(prestadorLat, prestadorLng) {
        cameraPositionState.animate(
            update = CameraUpdateFactory.newLatLng(prestadorPos),
            durationMs = 1000
        )
    }

    // Limpa WebSocket ao sair
    DisposableEffect(Unit) {
        onDispose {
            webSocketManager.disconnect()
        }
    }

    val prestadorNome = servico?.prestador?.usuario?.nome ?: "Prestador"
    val tempoEstimado = viewModel.calcularTempoEstimado()

    // Animação de pulse para o indicador de conexão
    val infiniteTransition = rememberInfiniteTransition(label = "pulse")
    val pulseAlpha by infiniteTransition.animateFloat(
        initialValue = 0.3f,
        targetValue = 1f,
        animationSpec = infiniteRepeatable(
            animation = tween(1000),
            repeatMode = RepeatMode.Reverse
        ),
        label = "pulseAlpha"
    )

    Box(modifier = Modifier.fillMaxSize()) {
        // Mapa com estilo melhorado
        GoogleMap(
            modifier = Modifier.fillMaxSize(),
            cameraPositionState = cameraPositionState,
            properties = MapProperties(
                isMyLocationEnabled = false,
                mapType = MapType.NORMAL
            ),
            uiSettings = MapUiSettings(
                zoomControlsEnabled = false,
                myLocationButtonEnabled = false,
                compassEnabled = true,
                scrollGesturesEnabled = true,
                zoomGesturesEnabled = true
            )
        ) {
            // Marcador do prestador (motorista)
            Marker(
                state = MarkerState(position = prestadorPos),
                title = prestadorNome,
                snippet = "Prestador - ${if (isSocketConnected) "Ao vivo" else "Offline"}",
                icon = BitmapDescriptorFactory.defaultMarker(BitmapDescriptorFactory.HUE_GREEN)
            )

            // Marcador do destino
            Marker(
                state = MarkerState(position = destinoPos),
                title = "Destino",
                snippet = servico?.localizacao?.endereco ?: "",
                icon = BitmapDescriptorFactory.defaultMarker(BitmapDescriptorFactory.HUE_RED)
            )
        }

        // Header com indicador de tempo real
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp)
                .statusBarsPadding()
                .align(Alignment.TopCenter),
            shape = RoundedCornerShape(20.dp),
            colors = CardDefaults.cardColors(
                containerColor = Color.White.copy(alpha = 0.95f)
            ),
            elevation = CardDefaults.cardElevation(12.dp)
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(16.dp)
            ) {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    IconButton(
                        onClick = { navController.popBackStack() },
                        modifier = Modifier
                            .size(42.dp)
                            .background(Color(0xFF019D31).copy(alpha = 0.1f), CircleShape)
                    ) {
                        Icon(
                            Icons.AutoMirrored.Filled.KeyboardArrowLeft,
                            contentDescription = "Voltar",
                            tint = Color(0xFF019D31),
                            modifier = Modifier.size(24.dp)
                        )
                    }

                    Column(
                        horizontalAlignment = Alignment.CenterHorizontally,
                        modifier = Modifier.weight(1f)
                    ) {
                        Text(
                            text = "Serviço em andamento",
                            fontSize = 16.sp,
                            fontWeight = FontWeight.Bold,
                            color = Color(0xFF2D2D2D)
                        )

                        // Indicador de conexão em tempo real
                        Row(
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.Center,
                            modifier = Modifier.padding(top = 4.dp)
                        ) {
                            Box(
                                modifier = Modifier
                                    .size(8.dp)
                                    .background(
                                        if (isSocketConnected) Color(0xFF00FF00).copy(alpha = pulseAlpha)
                                        else Color(0xFFFF0000),
                                        CircleShape
                                    )
                            )
                            Spacer(modifier = Modifier.width(6.dp))
                            Text(
                                text = if (isSocketConnected) "Ao vivo" else "Offline",
                                fontSize = 11.sp,
                                color = if (isSocketConnected) Color(0xFF019D31) else Color(0xFFFF0000),
                                fontWeight = FontWeight.Medium
                            )
                        }

                        if (tempoEstimado > 0) {
                            Text(
                                text = "Chega em ~$tempoEstimado min",
                                fontSize = 13.sp,
                                color = Color(0xFF019D31),
                                fontWeight = FontWeight.SemiBold,
                                modifier = Modifier.padding(top = 2.dp)
                            )
                        }
                    }

                    IconButton(
                        onClick = { mostrarDetalhes = !mostrarDetalhes },
                        modifier = Modifier
                            .size(42.dp)
                            .background(Color(0xFF019D31).copy(alpha = 0.1f), CircleShape)
                    ) {
                        Icon(
                            if (mostrarDetalhes) Icons.Default.ExpandLess else Icons.Default.ExpandMore,
                            contentDescription = "Mais detalhes",
                            tint = Color(0xFF019D31),
                            modifier = Modifier.size(24.dp)
                        )
                    }
                }

                // Detalhes expandíveis
                if (mostrarDetalhes) {
                    Spacer(modifier = Modifier.height(12.dp))
                    HorizontalDivider(color = Color(0xFFE0E0E0))
                    Spacer(modifier = Modifier.height(12.dp))

                    Column(
                        modifier = Modifier.fillMaxWidth(),
                        verticalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        DetailRow(
                            icon = Icons.Default.Category,
                            label = "Categoria",
                            value = servico?.categoria?.nome ?: "N/A"
                        )
                        DetailRow(
                            icon = Icons.Default.AttachMoney,
                            label = "Valor",
                            value = "R$ ${servico?.valor ?: "0,00"}"
                        )
                        DetailRow(
                            icon = Icons.Default.LocationOn,
                            label = "Destino",
                            value = servico?.localizacao?.endereco ?: "N/A",
                            maxLines = 2
                        )
                    }
                }
            }
        }

        // Card inferior com informações detalhadas do prestador
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .align(Alignment.BottomCenter)
                .padding(16.dp)
                .navigationBarsPadding(),
            shape = RoundedCornerShape(24.dp),
            colors = CardDefaults.cardColors(
                containerColor = Color.White
            ),
            elevation = CardDefaults.cardElevation(16.dp)
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .verticalScroll(rememberScrollState())
                    .padding(20.dp)
            ) {
                // Linha decorativa no topo
                Box(
                    modifier = Modifier
                        .width(40.dp)
                        .height(4.dp)
                        .background(Color(0xFFE0E0E0), RoundedCornerShape(2.dp))
                        .align(Alignment.CenterHorizontally)
                )

                Spacer(modifier = Modifier.height(16.dp))

                // Cabeçalho do prestador
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    verticalAlignment = Alignment.Top
                ) {
                    // Avatar do prestador com borda gradiente
                    Box(
                        modifier = Modifier
                            .size(72.dp)
                            .border(
                                width = 3.dp,
                                brush = Brush.linearGradient(
                                    colors = listOf(Color(0xFF019D31), Color(0xFF06C755))
                                ),
                                shape = CircleShape
                            )
                            .padding(3.dp)
                    ) {
                        Box(
                            modifier = Modifier
                                .fillMaxSize()
                                .background(Color(0xFF019D31), CircleShape),
                            contentAlignment = Alignment.Center
                        ) {
                            Icon(
                                Icons.Default.Person,
                                contentDescription = null,
                                tint = Color.White,
                                modifier = Modifier.size(36.dp)
                            )
                        }
                    }

                    Spacer(modifier = Modifier.width(16.dp))

                    Column(modifier = Modifier.weight(1f)) {
                        Text(
                            text = prestadorNome,
                            fontSize = 20.sp,
                            fontWeight = FontWeight.Bold,
                            color = Color(0xFF2D2D2D)
                        )

                        Spacer(modifier = Modifier.height(4.dp))

                        // Avaliação com estrelas
                        Row(verticalAlignment = Alignment.CenterVertically) {
                            repeat(5) { index ->
                                Icon(
                                    Icons.Default.Star,
                                    contentDescription = null,
                                    tint = if (index < (servico?.prestador?.avaliacao?.toInt() ?: 5))
                                        Color(0xFFFFD700) else Color(0xFFE0E0E0),
                                    modifier = Modifier.size(18.dp)
                                )
                            }
                            Spacer(modifier = Modifier.width(6.dp))
                            Text(
                                text = "${servico?.prestador?.avaliacao ?: "5.0"} (${servico?.prestador?.totalAvaliacoes ?: "0"})",
                                fontSize = 13.sp,
                                color = Color(0xFF6D6D6D),
                                fontWeight = FontWeight.Medium
                            )
                        }

                        Spacer(modifier = Modifier.height(6.dp))

                        // Telefone do prestador
                        servico?.prestador?.usuario?.telefone?.let { telefone ->
                            Row(verticalAlignment = Alignment.CenterVertically) {
                                Icon(
                                    Icons.Default.Phone,
                                    contentDescription = null,
                                    tint = Color(0xFF6D6D6D),
                                    modifier = Modifier.size(14.dp)
                                )
                                Spacer(modifier = Modifier.width(4.dp))
                                Text(
                                    text = telefone,
                                    fontSize = 12.sp,
                                    color = Color(0xFF6D6D6D)
                                )
                            }
                        }
                    }
                }

                Spacer(modifier = Modifier.height(16.dp))

                // Botões de ação
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    Button(
                        onClick = { /* Ligar */ },
                        modifier = Modifier
                            .weight(1f)
                            .height(48.dp),
                        shape = RoundedCornerShape(12.dp),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = Color(0xFF019D31)
                        )
                    ) {
                        Icon(
                            Icons.Default.Phone,
                            contentDescription = null,
                            modifier = Modifier.size(20.dp)
                        )
                        Spacer(modifier = Modifier.width(8.dp))
                        Text("Ligar", fontSize = 14.sp, fontWeight = FontWeight.SemiBold)
                    }

                    OutlinedButton(
                        onClick = { /* Chat */ },
                        modifier = Modifier
                            .weight(1f)
                            .height(48.dp),
                        shape = RoundedCornerShape(12.dp),
                        colors = ButtonDefaults.outlinedButtonColors(
                            contentColor = Color(0xFF019D31)
                        ),
                        border = androidx.compose.foundation.BorderStroke(2.dp, Color(0xFF019D31))
                    ) {
                        Icon(
                            Icons.AutoMirrored.Filled.Message,
                            contentDescription = null,
                            modifier = Modifier.size(20.dp)
                        )
                        Spacer(modifier = Modifier.width(8.dp))
                        Text("Chat", fontSize = 14.sp, fontWeight = FontWeight.SemiBold)
                    }
                }

                Spacer(modifier = Modifier.height(20.dp))

                HorizontalDivider(color = Color(0xFFE0E0E0), thickness = 1.dp)

                Spacer(modifier = Modifier.height(20.dp))

                // Informações do veículo
                servico?.prestador?.veiculo?.let { veiculo ->
                    InfoSection(
                        title = "Veículo",
                        icon = Icons.Default.DirectionsCar,
                        items = listOf(
                            InfoItem("Modelo", "${veiculo.marca} ${veiculo.modelo}"),
                            InfoItem("Placa", veiculo.placa ?: "N/A"),
                            InfoItem("Cor", veiculo.cor ?: "N/A"),
                            InfoItem("Ano", veiculo.ano?.toString() ?: "N/A")
                        )
                    )

                    Spacer(modifier = Modifier.height(20.dp))
                    HorizontalDivider(color = Color(0xFFE0E0E0), thickness = 1.dp)
                    Spacer(modifier = Modifier.height(20.dp))
                }

                // Informações do serviço
                InfoSection(
                    title = "Detalhes do Serviço",
                    icon = Icons.Default.Info,
                    items = buildList {
                        add(InfoItem("Status", when (servico?.status) {
                            "EM_ANDAMENTO" -> "Em andamento"
                            "CONCLUIDO" -> "Concluído"
                            else -> "Aguardando"
                        }))
                        add(InfoItem("Categoria", servico?.categoria?.nome ?: "N/A"))
                        add(InfoItem("Valor", "R$ ${servico?.valor ?: "0,00"}"))
                        servico?.descricao?.let { desc ->
                            if (desc.isNotEmpty()) add(InfoItem("Descrição", desc))
                        }
                    }
                )

                Spacer(modifier = Modifier.height(20.dp))

                // Botão cancelar com estilo melhorado
                OutlinedButton(
                    onClick = { mostrarDialogoCancelar = true },
                    modifier = Modifier
                        .fillMaxWidth()
                        .height(52.dp),
                    shape = RoundedCornerShape(16.dp),
                    colors = ButtonDefaults.outlinedButtonColors(
                        contentColor = Color(0xFFFF4444)
                    ),
                    border = androidx.compose.foundation.BorderStroke(2.dp, Color(0xFFFF4444))
                ) {
                    Icon(
                        Icons.Default.Cancel,
                        contentDescription = null,
                        modifier = Modifier.size(22.dp)
                    )
                    Spacer(modifier = Modifier.width(10.dp))
                    Text(
                        "Cancelar Serviço",
                        fontSize = 15.sp,
                        fontWeight = FontWeight.Bold
                    )
                }
            }
        }

        // Loading overlay
        if (isLoading) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .background(Color.Black.copy(alpha = 0.3f)),
                contentAlignment = Alignment.Center
            ) {
                CircularProgressIndicator(color = Color(0xFF00B14F))
            }
        }
    }

    // Dialog de cancelamento
    if (mostrarDialogoCancelar) {
        AlertDialog(
            onDismissRequest = { mostrarDialogoCancelar = false },
            icon = {
                Icon(
                    Icons.Default.Warning,
                    contentDescription = null,
                    tint = Color(0xFFFF6B6B),
                    modifier = Modifier.size(48.dp)
                )
            },
            title = {
                Text("Cancelar Serviço?", fontWeight = FontWeight.Bold)
            },
            text = {
                Text(
                    "Tem certeza que deseja cancelar este serviço? Esta ação não pode ser desfeita.",
                    textAlign = TextAlign.Center
                )
            },
            confirmButton = {
                Button(
                    onClick = {
                        viewModel.cancelarServico(
                            token = token,
                            servicoId = servicoId,
                            onSuccess = {
                                mostrarDialogoCancelar = false
                                Toast.makeText(context, "Serviço cancelado", Toast.LENGTH_SHORT).show()
                                navController.navigate("tela_home") {
                                    popUpTo("tela_home") { inclusive = true }
                                }
                            },
                            onError = { erro ->
                                Toast.makeText(context, erro, Toast.LENGTH_LONG).show()
                            }
                        )
                    },
                    colors = ButtonDefaults.buttonColors(
                        containerColor = Color(0xFFFF6B6B)
                    )
                ) {
                    Text("Sim, Cancelar")
                }
            },
            dismissButton = {
                TextButton(onClick = { mostrarDialogoCancelar = false }) {
                    Text("Não")
                }
            }
        )
    }
}

// Componentes auxiliares
@Composable
fun DetailRow(
    icon: ImageVector,
    label: String,
    value: String,
    maxLines: Int = 1
) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        verticalAlignment = Alignment.CenterVertically
    ) {
        Icon(
            icon,
            contentDescription = null,
            tint = Color(0xFF019D31),
            modifier = Modifier.size(18.dp)
        )
        Spacer(modifier = Modifier.width(8.dp))
        Text(
            text = "$label: ",
            fontSize = 13.sp,
            fontWeight = FontWeight.SemiBold,
            color = Color(0xFF6D6D6D)
        )
        Text(
            text = value,
            fontSize = 13.sp,
